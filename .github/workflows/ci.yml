name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  cpu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain (nightly-2023-05-27)
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly-2023-05-27
          components: rustfmt, clippy, rust-src

      - name: Install wasm-pack
        run: curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Clippy (CPU path)
        run: |
          cargo clippy -p zeldhash-miner-core --no-default-features --features std -- -D warnings
          cargo clippy -p zeldhash-miner --no-default-features --features cpu -- -D warnings

      - name: Tests (CPU path)
        run: |
          cargo test -p zeldhash-miner-core
          cargo test -p zeldhash-miner --no-default-features --features cpu

      - name: Check no-std core
        run: cargo check -p zeldhash-miner-core --no-default-features

      - name: Build wasm bindings
        run: wasm-pack build crates/zeldhash-miner-wasm --target web

  gpu:
    if: github.event_name == 'workflow_dispatch'
    needs: cpu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (X11/udev for wgpu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libasound2-dev libudev-dev pkg-config libxkbcommon-dev libwayland-dev

      - name: Install Rust toolchain (nightly-2023-05-27)
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly-2023-05-27
          components: rustfmt, clippy, rust-src

      - name: Build GPU crates
        run: |
          cargo build -p zeldhash-miner-gpu --no-default-features --features gpu
          cargo test -p zeldhash-miner --no-default-features --features "cpu gpu"

