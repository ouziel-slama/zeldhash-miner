name: Release (crates + npm)

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: "Run preflight tests before publishing"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      wasm_gpu:
        description: "Build WASM with GPU bindings (requires nightly toolchain)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      RUSTFLAGS: --cfg=web_sys_unstable_apis
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2023-05-27
          components: rustfmt, clippy

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          always-auth: true

      - name: Show versions
        run: |
          echo "Rust crates (expected 0.1.0):"
          grep '^version' crates/*/Cargo.toml facades/rust/Cargo.toml
          echo "npm package version (expected 0.1.0):"
          node -p 'require("./facades/typescript/package.json").version'

      - name: Cargo fmt check
        if: inputs.run_tests == 'true'
        run: cargo fmt --all -- --check

      - name: Cargo tests (core + facade CPU)
        if: inputs.run_tests == 'true'
        run: |
          cargo test -p zeldhash-miner-core --locked
          cargo test -p zeldhash-miner --locked --no-default-features --features "cpu serde"

      - name: Cargo tests (facade GPU/WebGPU)
        if: inputs.run_tests == 'true'
        env:
          WGPU_BACKEND: gl
        run: |
          cargo test -p zeldhash-miner --locked --no-default-features --features "cpu gpu serde"

      - name: Build WASM bindings
        run: |
          # Normalize the workflow input (true/false) into 1/0 for build-wasm.sh
          export WASM_GPU=$([ "${{ inputs.wasm_gpu }}" = "true" ] && echo 1 || echo 0)
          ./scripts/build-wasm.sh

      - name: Install TypeScript dependencies
        if: inputs.run_tests == 'true'
        run: npm ci --prefix facades/typescript

      - name: TypeScript typecheck
        if: inputs.run_tests == 'true'
        run: npm run typecheck --prefix facades/typescript

      - name: TypeScript tests
        if: inputs.run_tests == 'true'
        run: npm test --prefix facades/typescript

      - name: Build TypeScript package
        run: |
          if [ "${{ inputs.run_tests }}" != "true" ]; then
            npm ci --prefix facades/typescript
          fi
          npm run build --prefix facades/typescript

      - name: Publish Rust crates to crates.io
        env:
          SKIP_TESTS: 1 # tests already ran earlier in the workflow
        run: ./scripts/release-crate.sh

      - name: Publish npm package
        run: |
          cd facades/typescript
          npm publish --access public

